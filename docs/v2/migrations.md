# ðŸ“‹ MIGRATION ORDER & IMPLEMENTATION

> **Status**: âœ… IMPLEMENTED

1. Migration **master data dulu**
2. Permission tables (Spatie)
3. Core business tables
4. Supporting tables (schedules, holidays, locations)
5. Index & constraint

# ðŸ“ STRUKTUR FILE (ACTUAL)

```
database/migrations/
â”œâ”€â”€ 0001_01_01_000000_create_users_table.php
â”œâ”€â”€ 0001_01_01_000001_create_cache_table.php
â”œâ”€â”€ 0001_01_01_000002_create_jobs_table.php
â”œâ”€â”€ 2026_01_05_044106_add_deleted_at_to_users_table.php
â”œâ”€â”€ 2026_01_06_091735_create_departments_table.php
â”œâ”€â”€ 2026_01_06_093147_create_employees_table.php
â”œâ”€â”€ 2026_01_06_094337_create_attendances_table.php
â”œâ”€â”€ 2026_01_06_095508_create_leaves_table.php
â”œâ”€â”€ 2026_01_06_100259_create_overtimes_table.php
â”œâ”€â”€ 2026_01_07_063645_create_personal_access_tokens_table.php
â”œâ”€â”€ 2026_01_10_155155_create_permission_tables.php
â”œâ”€â”€ 2026_01_15_000001_create_work_schedules_table.php
â”œâ”€â”€ 2026_01_15_000002_create_holidays_table.php
â”œâ”€â”€ 2026_01_15_000003_add_notes_to_attendances_table.php
â”œâ”€â”€ 2026_01_15_100000_fix_permission_tables_uuid.php
â””â”€â”€ 2026_01_17_000001_create_locations_table.php

app/Models/
â”œâ”€â”€ User.php
â”œâ”€â”€ Employee.php
â”œâ”€â”€ Department.php
â”œâ”€â”€ Attendance.php
â”œâ”€â”€ Leave.php
â”œâ”€â”€ Overtime.php
â”œâ”€â”€ WorkSchedule.php
â”œâ”€â”€ Holiday.php
â””â”€â”€ Location.php

app/Enums/
â”œâ”€â”€ AttendanceSource.php
â”œâ”€â”€ AttendanceStatus.php
â””â”€â”€ DayOfWeek.php
```

---

# 1ï¸âƒ£ USERS

> Laravel default â†’ **PAKAI**, dengan soft deletes

### Migration (Modify existing)

```php
// 2026_01_05_044106_add_deleted_at_to_users_table.php
Schema::table('users', function (Blueprint $table) {
    $table->softDeletes();
});
```

### Partial Unique Index (PostgreSQL)

```php
DB::statement("
    CREATE UNIQUE INDEX users_email_unique
    ON users(email)
    WHERE deleted_at IS NULL
");
```

### Model

```php
class User extends Authenticatable
{
    use HasFactory, Notifiable, SoftDeletes;
    use HasRoles; // Spatie

    protected $fillable = ['name', 'email', 'password'];

    protected $hidden = ['password', 'remember_token'];

    protected function casts(): array
    {
        return [
            'email_verified_at' => 'datetime',
            'password' => 'hashed',
        ];
    }

    public function employee(): HasOne
    {
        return $this->hasOne(Employee::class);
    }
}
```

---

# 2ï¸âƒ£ PERMISSION TABLES (Spatie Laravel Permission) âœ…

> Menggunakan **spatie/laravel-permission** package

### Migration

```php
// 2026_01_10_155155_create_permission_tables.php
// Generated by: php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider"

// 2026_01_15_100000_fix_permission_tables_uuid.php
// Fix untuk UUID pada model_id (karena users.id = UUID)
Schema::table('model_has_permissions', function (Blueprint $table) {
    $table->dropColumn('model_id');
});
Schema::table('model_has_permissions', function (Blueprint $table) {
    $table->uuid('model_id');
});
// ... same for model_has_roles
```

---

# 3ï¸âƒ£ DEPARTMENTS

### Migration

```php
// 2026_01_06_091735_create_departments_table.php
Schema::create('departments', function (Blueprint $table) {
    $table->id();
    $table->string('name');
    $table->foreignId('parent_id')->nullable()
          ->constrained('departments')
          ->nullOnDelete();
    $table->timestamps();
    $table->softDeletes();
});
```

### Model

```php
class Department extends Model
{
    use SoftDeletes;

    protected $fillable = ['name', 'parent_id'];

    public function parent(): BelongsTo
    {
        return $this->belongsTo(Department::class, 'parent_id');
    }

    public function children(): HasMany
    {
        return $this->hasMany(Department::class, 'parent_id');
    }

    public function employees(): HasMany
    {
        return $this->hasMany(Employee::class);
    }
}
```

---

# 4ï¸âƒ£ EMPLOYEES â­

### Migration

```php
// 2026_01_06_093147_create_employees_table.php
Schema::create('employees', function (Blueprint $table) {
    $table->id();
    $table->foreignUuid('user_id')->nullable()
          ->constrained()
          ->nullOnDelete();

    $table->string('employee_number');
    $table->string('name');
    $table->string('email')->nullable();
    $table->foreignId('department_id')->constrained();
    $table->string('status')->default('active');
    $table->date('joined_at')->nullable();
    $table->timestamps();
    $table->softDeletes();
});
```

### Partial Unique Index

```php
DB::statement("
    CREATE UNIQUE INDEX employees_number_unique
    ON employees(employee_number)
    WHERE deleted_at IS NULL
");
```

### Model

```php
class Employee extends Model
{
    use SoftDeletes;

    protected $fillable = [
        'user_id',
        'employee_number',
        'name',
        'email',
        'department_id',
        'status',
        'joined_at',
    ];

    protected $casts = [
        'joined_at' => 'date',
    ];

    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }

    public function department(): BelongsTo
    {
        return $this->belongsTo(Department::class);
    }

    public function attendances(): HasMany
    {
        return $this->hasMany(Attendance::class);
    }

    public function leaves(): HasMany
    {
        return $this->hasMany(Leave::class);
    }

    public function overtimes(): HasMany
    {
        return $this->hasMany(Overtime::class);
    }
}
```

---

# 5ï¸âƒ£ WORK SCHEDULES âœ… (NEW)

### Migration

```php
// 2026_01_15_000001_create_work_schedules_table.php
Schema::create('work_schedules', function (Blueprint $table) {
    $table->id();
    $table->unsignedTinyInteger('day_of_week')->unique(); // 0-6
    $table->boolean('is_working_day')->default(true);
    $table->time('work_start_time')->nullable();
    $table->time('work_end_time')->nullable();
    $table->timestamps();
});

// Seeder: 7 records (Sunday=0 to Saturday=6)
```

### Enum

```php
// app/Enums/DayOfWeek.php
enum DayOfWeek: int
{
    case Sunday = 0;
    case Monday = 1;
    case Tuesday = 2;
    case Wednesday = 3;
    case Thursday = 4;
    case Friday = 5;
    case Saturday = 6;

    public function label(): string
    {
        return match ($this) {
            self::Sunday => 'Minggu',
            self::Monday => 'Senin',
            // ...
        };
    }
}
```

### Model

```php
class WorkSchedule extends Model
{
    protected $fillable = [
        'day_of_week',
        'is_working_day',
        'work_start_time',
        'work_end_time',
    ];

    protected $casts = [
        'day_of_week' => DayOfWeek::class,
        'is_working_day' => 'boolean',
        'work_start_time' => 'datetime:H:i',
        'work_end_time' => 'datetime:H:i',
    ];

    public static function forDayOfWeek(int $dayOfWeek): ?self
    {
        return static::where('day_of_week', $dayOfWeek)->first();
    }

    public static function isWorkingDay(int $dayOfWeek): bool
    {
        $schedule = static::forDayOfWeek($dayOfWeek);
        return $schedule?->is_working_day ?? false;
    }
}
```

---

# 6ï¸âƒ£ HOLIDAYS âœ… (NEW)

### Migration

```php
// 2026_01_15_000002_create_holidays_table.php
Schema::create('holidays', function (Blueprint $table) {
    $table->id();
    $table->string('name');
    $table->date('date');
    $table->text('description')->nullable();
    $table->timestamps();
});
```

### Model

```php
class Holiday extends Model
{
    protected $fillable = [
        'name',
        'date',
        'description',
    ];

    protected $casts = [
        'date' => 'date',
    ];
}
```

---

# 7ï¸âƒ£ LOCATIONS âœ… (NEW - GEOFENCING)

### Migration

```php
// 2026_01_17_000001_create_locations_table.php
Schema::create('locations', function (Blueprint $table) {
    $table->id();
    $table->string('name');
    $table->decimal('latitude', 10, 8);
    $table->decimal('longitude', 11, 8);
    $table->unsignedInteger('radius_meters')->default(100);
    $table->text('address')->nullable();
    $table->boolean('is_active')->default(true);
    $table->timestamps();
});
```

### Model

```php
class Location extends Model
{
    protected $fillable = [
        'name',
        'latitude',
        'longitude',
        'radius_meters',
        'address',
        'is_active',
    ];

    protected $casts = [
        'latitude' => 'decimal:8',
        'longitude' => 'decimal:8',
        'radius_meters' => 'integer',
        'is_active' => 'boolean',
    ];

    public function scopeActive($query)
    {
        return $query->where('is_active', true);
    }

    /**
     * Check if coordinate is within radius (Haversine formula)
     */
    public function isWithinRadius(float $latitude, float $longitude): bool
    {
        $distance = $this->calculateDistance($latitude, $longitude);
        return $distance <= $this->radius_meters;
    }

    /**
     * Calculate distance in meters using Haversine formula
     */
    public function calculateDistance(float $latitude, float $longitude): float
    {
        $earthRadius = 6371000; // meters

        $latFrom = deg2rad($this->latitude);
        $lonFrom = deg2rad($this->longitude);
        $latTo = deg2rad($latitude);
        $lonTo = deg2rad($longitude);

        $latDelta = $latTo - $latFrom;
        $lonDelta = $lonTo - $lonFrom;

        $angle = 2 * asin(sqrt(
            pow(sin($latDelta / 2), 2) +
            cos($latFrom) * cos($latTo) * pow(sin($lonDelta / 2), 2)
        ));

        return $angle * $earthRadius;
    }

    public static function findNearest(float $latitude, float $longitude): ?self
    {
        return static::active()->get()
            ->sortBy(fn ($loc) => $loc->calculateDistance($latitude, $longitude))
            ->first();
    }

    public static function findContaining(float $latitude, float $longitude)
    {
        return static::active()->get()
            ->filter(fn ($loc) => $loc->isWithinRadius($latitude, $longitude));
    }
}
```

---

# 8ï¸âƒ£ ATTENDANCES (CORE)

### Migration

```php
// 2026_01_06_094337_create_attendances_table.php
Schema::create('attendances', function (Blueprint $table) {
    $table->id();
    $table->foreignId('employee_id')->constrained();
    $table->date('date');
    $table->timestamp('clock_in_at');
    $table->timestamp('clock_out_at')->nullable();
    $table->string('photo_path')->nullable();
    $table->decimal('latitude', 10, 7)->nullable();
    $table->decimal('longitude', 10, 7)->nullable();
    $table->string('source')->default('mobile');
    $table->timestamps();

    $table->index(['employee_id', 'date']);
});

// 2026_01_15_000003_add_notes_to_attendances_table.php
Schema::table('attendances', function (Blueprint $table) {
    $table->text('notes')->nullable()->after('source');
});
```

### Enums

```php
// app/Enums/AttendanceSource.php
enum AttendanceSource: string
{
    case Mobile = 'mobile';
    case Manual = 'manual';

    public function label(): string
    {
        return match ($this) {
            self::Mobile => 'Mobile',
            self::Manual => 'Manual',
        };
    }
}

// app/Enums/AttendanceStatus.php (untuk Review)
enum AttendanceStatus: string
{
    case Present = 'present';
    case Absent = 'absent';
    case OnLeave = 'on_leave';
    case Weekend = 'weekend';
    case Holiday = 'holiday';
    case NotYet = 'not_yet';

    public function label(): string { /* ... */ }
    public function color(): string { /* ... */ }
    public function icon(): string { /* ... */ }
}
```

### Model

```php
class Attendance extends Model
{
    protected $fillable = [
        'employee_id',
        'date',
        'clock_in_at',
        'clock_out_at',
        'photo_path',
        'latitude',
        'longitude',
        'source',
        'notes',
    ];

    protected $casts = [
        'date' => 'date',
        'clock_in_at' => 'datetime',
        'clock_out_at' => 'datetime',
        'source' => AttendanceSource::class,
    ];

    protected $appends = ['is_late', 'late_duration_minutes'];

    public function employee(): BelongsTo
    {
        return $this->belongsTo(Employee::class);
    }

    // Computed: is_late (cek terhadap work_schedules)
    protected function isLate(): Attribute
    {
        return Attribute::make(
            get: function (): bool {
                if (!$this->clock_in_at || !$this->date) return false;

                $schedule = WorkSchedule::forDayOfWeek($this->date->dayOfWeek);
                if (!$schedule?->is_working_day) return false;

                $expected = Carbon::parse($this->date->format('Y-m-d') . ' ' . $schedule->work_start_time->format('H:i:s'));
                return $this->clock_in_at->gt($expected);
            }
        );
    }

    // Computed: late_duration_minutes
    protected function lateDurationMinutes(): Attribute { /* ... */ }

    // Computed: is_early_leave
    public function getIsEarlyLeaveAttribute(): bool { /* ... */ }

    // Computed: work_duration_minutes
    public function getWorkDurationMinutesAttribute(): ?int { /* ... */ }
}
```

---

# 9ï¸âƒ£ LEAVES

### Migration

```php
// 2026_01_06_095508_create_leaves_table.php
Schema::create('leaves', function (Blueprint $table) {
    $table->id();
    $table->foreignId('employee_id')->constrained();
    $table->string('type'); // annual, sick, permission, unpaid
    $table->date('start_date');
    $table->date('end_date');
    $table->string('status')->default('pending');
    $table->text('reason')->nullable();
    $table->foreignUuid('approved_by')->nullable()
          ->constrained('users')
          ->nullOnDelete();
    $table->timestamps();
    $table->softDeletes();
});
```

### Model

```php
class Leave extends Model
{
    use SoftDeletes;

    protected $fillable = [
        'employee_id',
        'type',
        'start_date',
        'end_date',
        'status',
        'reason',
        'approved_by',
    ];

    protected $casts = [
        'start_date' => 'date',
        'end_date' => 'date',
    ];

    public function employee(): BelongsTo
    {
        return $this->belongsTo(Employee::class);
    }

    public function approver(): BelongsTo
    {
        return $this->belongsTo(User::class, 'approved_by');
    }

    protected static function booted(): void
    {
        static::saving(function (self $model) {
            if ($model->status !== 'approved') {
                $model->approved_by = null;
            }
        });
    }
}
```

---

# ðŸ”Ÿ OVERTIMES

### Migration

```php
// 2026_01_06_100259_create_overtimes_table.php
Schema::create('overtimes', function (Blueprint $table) {
    $table->id();
    $table->foreignId('employee_id')->constrained();
    $table->date('date');
    $table->time('start_time');
    $table->time('end_time');
    $table->string('status')->default('pending');
    $table->text('reason')->nullable();
    $table->foreignUuid('approved_by')->nullable()
          ->constrained('users')
          ->nullOnDelete();
    $table->timestamps();
    $table->softDeletes();
});
```

---

# ðŸ“‹ MIGRATION FILES SUMMARY

| Order | File | Table | Status |
|-------|------|-------|--------|
| 1 | 0001_01_01_000000 | users | âœ… Laravel default |
| 2 | 0001_01_01_000001 | cache | âœ… Laravel default |
| 3 | 0001_01_01_000002 | jobs | âœ… Laravel default |
| 4 | 2026_01_05_044106 | users (soft delete) | âœ… |
| 5 | 2026_01_06_091735 | departments | âœ… |
| 6 | 2026_01_06_093147 | employees | âœ… |
| 7 | 2026_01_06_094337 | attendances | âœ… |
| 8 | 2026_01_06_095508 | leaves | âœ… |
| 9 | 2026_01_06_100259 | overtimes | âœ… |
| 10 | 2026_01_07_063645 | personal_access_tokens | âœ… Sanctum |
| 11 | 2026_01_10_155155 | permission_tables | âœ… Spatie |
| 12 | 2026_01_15_000001 | work_schedules | âœ… |
| 13 | 2026_01_15_000002 | holidays | âœ… |
| 14 | 2026_01_15_000003 | attendances (notes) | âœ… |
| 15 | 2026_01_15_100000 | permission_tables (UUID fix) | âœ… |
| 16 | 2026_01_17_000001 | locations | âœ… |

---